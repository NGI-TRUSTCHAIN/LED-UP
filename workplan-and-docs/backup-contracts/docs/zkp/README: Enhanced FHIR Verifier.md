# Enhanced FHIR Verifier

The Enhanced FHIR Verifier is a smart contract designed to verify FHIR (Fast Healthcare Interoperability Resources) data using zero-knowledge proofs. It provides an advanced verification system with multiple modes and extends the capabilities of the original FHIR Verifier.

## Overview

The Enhanced FHIR Verifier enables private and secure validation of healthcare data on the blockchain. It verifies the integrity and correctness of FHIR resources without exposing sensitive information, using ZKP (Zero-Knowledge Proof) technology. The verifier supports:

1. Extended resource types (16 types)
2. Basic validation of resource integrity
3. Selective disclosure of specific fields
4. Reference validation between related resources

## Architecture

The system consists of the following components:

1. **EnhancedFHIRVerifier Contract**: The main contract that validates FHIR resources using zero-knowledge proofs.
2. **ZoKrates Circuit**: A circuit (`enhancedFhirCheck.zok`) that performs the off-chain computation to generate proofs.
3. **ZoKrates-generated Verifier**: A contract generated by ZoKrates that verifies the cryptographic proof.

The EnhancedFHIRVerifier acts as a wrapper around the ZoKrates-generated verifier, providing additional functionality and a healthcare-specific interface.

## Features

### Resource Type Validation

The verifier supports 16 FHIR resource types:

- Patient
- Observation
- MedicationRequest
- Condition
- Procedure
- Encounter
- DiagnosticReport
- CarePlan
- Immunization
- AllergyIntolerance
- Device
- Organization
- Practitioner
- Location
- Medication
- Coverage

### Verification Modes

#### 1. Basic Validation

Verifies the integrity of a FHIR resource by checking its hash and resource type.

```solidity
function verifyEnhancedFHIRResource(
    uint256[2] calldata a,
    uint256[2][2] calldata b,
    uint256[2] calldata c,
    ResourceType resourceType,
    uint256[2] calldata expectedHash
) external returns (bool result, VerificationErrorCode errorCode)
```

#### 2. Selective Disclosure

Validates a FHIR resource while allowing specific fields to be disclosed or redacted.

```solidity
function verifyEnhancedFHIRResourceWithSelectiveDisclosure(
    uint256[2] calldata a,
    uint256[2][2] calldata b,
    uint256[2] calldata c,
    ResourceType resourceType,
    uint256[2] calldata expectedHash,
    uint256[8] calldata disclosureMask
) external returns (bool result, VerificationErrorCode errorCode)
```

#### 3. Reference Validation

Verifies that a FHIR resource correctly references another resource (e.g., an Observation references a Patient).

```solidity
function verifyEnhancedFHIRResourceWithReference(
    uint256[2] calldata a,
    uint256[2][2] calldata b,
    uint256[2] calldata c,
    ResourceType resourceType,
    uint256[2] calldata expectedHash,
    ResourceType referencedResourceType,
    uint256[8] calldata referencedResourceData
) external returns (bool result, VerificationErrorCode errorCode)
```

### Error Handling

The verifier provides detailed error codes to aid in debugging and verification issues:

- `Success`: Verification was successful
- `InvalidInput`: Invalid input parameters
- `InvalidResourceType`: Resource type is not supported
- `InvalidHash`: Hash mismatch in verification
- `MissingRequiredFields`: Required fields for the resource type are missing
- `InvalidDisclosure`: Selective disclosure verification failed
- `InsufficientDisclosure`: Minimum required disclosure not met
- `InvalidReference`: Reference validation failed

## ZoKrates Circuit

The `enhancedFhirCheck.zok` circuit implements the following validations:

1. Resource type validation
2. Required field validation per resource type
3. Hash validation
4. Selective disclosure validation
5. Reference validation
6. Minimum disclosure requirements

## Usage

### Proof Generation

1. Prepare your FHIR resource data
2. Run the ZoKrates circuit to generate a proof:
   ```bash
   ./generate_enhanced_proof.sh [resource_type] [resource_data_file] [mode]
   ```

### Smart Contract Verification

Depending on your verification needs:

```javascript
// Basic verification
const result = await enhancedFhirVerifier.verifyEnhancedFHIRResource(
  proof.a,
  proof.b,
  proof.c,
  resourceType,
  expectedHash
);

// Selective disclosure
const result = await enhancedFhirVerifier.verifyEnhancedFHIRResourceWithSelectiveDisclosure(
  proof.a,
  proof.b,
  proof.c,
  resourceType,
  expectedHash,
  disclosureMask
);

// Reference validation
const result = await enhancedFhirVerifier.verifyEnhancedFHIRResourceWithReference(
  proof.a,
  proof.b,
  proof.c,
  resourceType,
  expectedHash,
  referencedResourceType,
  referencedResourceData
);
```

## Security Considerations

- The EnhancedFHIRVerifier relies on the security of the underlying ZoKrates-generated verifier
- Input validation is performed to prevent invalid resource types and disclosure masks
- Events are emitted for all verification operations to provide an audit trail
- Error codes provide specific information about verification failures without revealing sensitive data

## Testing

Comprehensive tests cover all verification modes, edge cases, and error handling:

```typescript
// Run tests
npx hardhat test ./test/hardhat/zkp/EnhancedFHIRVerifier.test.ts
```

## Gas Optimization

- The verifier minimizes on-chain data processing by relying on the ZKP system
- Input arrays are created dynamically to match the specific verification mode
- Selective disclosure and reference validation are only used when needed

## Integration

This verifier can be integrated with:

1. DID Registry for identity management
2. Data Registry for managing healthcare data access
3. Consent Management for patient permissions
4. Compensation contracts for data sharing incentives

## Future Enhancements

Potential improvements to the system:

1. Support for more complex FHIR resource types
2. Multi-resource relationship validation
3. Fine-grained attribute validation
4. Integration with trusted external data sources
5. Support for FHIR R5 updates

## Conclusion

The Enhanced FHIR Verifier provides a powerful tool for healthcare data verification on the blockchain. By leveraging zero-knowledge proofs, it enables secure and private validation of healthcare information while maintaining regulatory compliance.
